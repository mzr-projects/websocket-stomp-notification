services:
  jobmanager:
    image: flink:1.19.1-scala_2.12-java11
    restart: unless-stopped
    command: jobmanager
    ports:
      - "8081:8081"      # Flink Web UI
      - "6123:6123"      # RPC (client/job submission)
    environment:
      - |
            FLINK_PROPERTIES=
            # Core cluster wiring
            jobmanager.rpc.address: jobmanager
            jobmanager.rpc.port: 6123
            rest.address: jobmanager
            rest.bind-address: 0.0.0.0
            rest.port: 8081
            blob.server.port: 6124

            # Resources (tune via .env)
            jobmanager.memory.process.size: ${FLINK_JM_PROCESS_SIZE:-1600m}
            parallelism.default: ${FLINK_PARALLELISM:-2}

            # Reliability / restart
            restart-strategy: fixed-delay
            restart-strategy.fixed-delay.attempts: 10
            restart-strategy.fixed-delay.delay: 10

    # Make host.docker.internal resolve on Linux, too (works on Windows/macOS by default)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Persist logs, state, and load connectors/jars
    volumes:
      - ./flink/log:/opt/flink/log
      - ./flink/lib:/opt/flink/lib
      - ./flink/usrlib:/opt/flink/usrlib
      - ./flink/checkpoints:/opt/flink/checkpoints
      - ./flink/savepoints:/opt/flink/savepoints

    # Optional log rotation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    # Useful limits (ignored on some platforms)
    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576

    networks:
      - flink-net

  taskmanager:
    image: flink:1.19.1-scala_2.12-java11
    restart: unless-stopped
    depends_on:
      - jobmanager
    command: taskmanager
    environment:
      - |
            FLINK_PROPERTIES=
            jobmanager.rpc.address: jobmanager
            jobmanager.rpc.port: 6123

            # Resources (tune via .env)
            taskmanager.memory.process.size: ${FLINK_TM_PROCESS_SIZE:-4096m}
            taskmanager.numberOfTaskSlots: ${FLINK_TM_SLOTS:-2}
            taskmanager.resource.cpu: ${FLINK_TM_CPU:-2.0}

            # Pin data port for NAT friendliness
            taskmanager.data.port: 6121

            # Metrics (Prometheus)
            metrics.reporters: prom
            metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
            metrics.reporter.prom.port: 9250-9260

    # Allow reaching host services consistently across platforms
    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      - ./flink/log:/opt/flink/log
      - ./flink/lib:/opt/flink/lib
      - ./flink/usrlib:/opt/flink/usrlib
      - ./flink/checkpoints:/opt/flink/checkpoints
      - ./flink/savepoints:/opt/flink/savepoints

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    networks:
      - flink-net

networks:
  flink-net:
    driver: bridge
